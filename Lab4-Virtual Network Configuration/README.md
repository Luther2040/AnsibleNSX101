# Virtual Networking Configuration
In the previous labs, you installed NSX Manager, registered it with vCenter and setup control and data plane components. NSX is now ready to start providing virtual network & security services. This section covers the configuration and provisioning of edge routing, distributed routing and logical switching. 

This Lab includes the following sections:

- [Lab Topology Review]()
- [Logical Switching]()
- [Distributed Routing]()
- [Edge Routing]()


## Lab 4 Virtual Networking Topology

This lab will go through each of the NSX Ansible Networking configuration modules. Completion of all of the exercises in Lab 4 will result in the following virtual network topology:

![topology image]() 

## Logical Switching
In this section, you will make a playbook to create each of the logical switches required to complete the Lab 4 Virtual Networking Topology. 

### Create the Playbook
- An NSX Logical switch can be created with a single task
    - The playbook you create in this section will use 4 copies of the same task to create 4 logical switches, TransitLS, WebLS, AppLS and DBLS. 
- Create the playbook
  - Return to your terminal session with the Ansible server
  - `cd ~/nsxansible`
  - `vi createLS.yml`
  - Edit the file to look like the following:
```
---
- hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
     - answerfile.yml
  tasks:
  - name: Create logical switch 
    nsx_logical_switch:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      transportzone: "TZ"
      name: "TransitLS"
      controlplanemode: "UNICAST_MODE"
      description: "Transit LS"
    register: create_logical_switch

  - name: Create logical switch 
    nsx_logical_switch:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      transportzone: "TZ"
      name: "WebLS"
      controlplanemode: "UNICAST_MODE"
      description: "Web Tier LS"
    register: create_logical_switch

  - name: Create logical switch 
    nsx_logical_switch:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      transportzone: "TZ"
      name: "AppLS"
      controlplanemode: "UNICAST_MODE"
      description: "App Tier LS"
    register: create_logical_switch

  - name: Create logical switch 
    nsx_logical_switch:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      transportzone: "TZ"
      name: "DBLS"
      controlplanemode: "UNICAST_MODE"
      description: "DB Tier LS"
    register: create_logical_switch
```

### Run the Playbook

- If the play completes successfully, you should see output similar to the following:
```
```

### Validate Results

## Distributed Routing

Now that you have created the logical switches for the lab environment, you will need to implement routing services to enable IP connectivity between the logical switch subnets. In this section you will create a playbook to install and configure distributing routing services. 

### Create The Playbook

In this section you will create and fully configure an NSX Distributed Logical Router (DLR). This DLR will serve as the default gateway for virtual machines connected to the WebLS, AppLS and DBLS Logical Switches that you created in the previous section on [Logical Switching](). The DLR will also connect to the TransitLS Logical Switch created in the previous section, and it will use this network to connect to an NSX Edge Services Gateway you will create in the next section. 

- The installation and configuration of the DLR requires several tasks that interact with multiple NSX Ansible modules. 
    - Task 1: Gather vCenter Moids
      - Description: 
        - Before you can deploy a DLR with the `nsx-dlr` ansible module, you first need to gather the MOIDs for the resource pool (Cluster), datacenter, datastore and management portgroup. In this playbook, you will build a single task that gathers all of these MOID values. Note that this is more streamlined than the method used in [Lab 3]() where you used a seperate task to gather each MOID independently. 
    - Task 2: DLR Creation
      - Description:
        - This task provides the needed values to create the DLR and provide the base IP configuration including interface configuration
    - Task 3: Configure OSPF DLR
      - Description:
        - Configure OSPF Settings on the DLR
    - Task 4: Configure OSPF Redistribution
      - Description:
        - The NSX Ansible Modules use a seperate module to configure route redistribution settings from the routing protocol configuration. This task will be used to enable automatic redistribution of directly connected interfaces into OSPF advertisements generated by the DLR. 
- Create the playbook
  - Return to your terminal session with the Ansible server
  - `cd ~/nsxansible`
  - `vi createDLR.yml`
  - Edit the file to look like the following:
```
---
- hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
     - answerfile.yml
  tasks:
  - name: Gather vCenter MOIDs
    vcenter_gather_moids:
      hostname: 'testvc.emea.nicira'
      username: 'administrator@vsphere.local'
      password: 'vmware'
      datacenter_name: 'nsxlabdc'
      cluster_name: 'compute'
      resourcepool_name: 'test_rp'
      dvs_name: 'TransportVDS'
      portgroup_name: 'VM Network'
      datastore_name: 'NFS-Storage03'
    register: gather_moids_output

  - name: DLR creation
    nsx_dlr:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      name: 'ansibleDLR'
      description: 'This DLR is created by nsxansible'
      resourcepool_moid: "{{ gather_moids_cl.object_id }}"
      datastore_moid: "{{ gather_moids_ds.object_id }}"
      datacenter_moid: "{{ gather_moids_cl.datacenter_moid }}"
      mgmt_portgroup_moid: "{{ gather_moids_pg.object_id }}"
      interfaces:
        - {name: 'Uplink vnic', ip: '192.168.178.2', prefix_len: 24, logical_switch: 'edge_ls', iftype: 'uplink'}
        - {name: 'Internal iface', ip: '172.16.1.1', prefix_len: 24, portgroup_id: "{{ gather_moids_pg.object_id }}", iftype: 'uplink'}
        - {name: 'Internal new', ip: '172.16.4.1', prefix_len: 26, logical_switch: 'new_lswitch_name', iftype: 'internal'}
      routes:
        - {network: '10.11.22.0/24', next_hop: '172.16.1.2', admin_distance: '1', mtu: '1500', description: 'very important route'}
        - {network: '10.11.23.0/24', next_hop: '172.16.1.2', mtu: '1600'}
        - {network: '10.11.24.0/24', next_hop: '172.16.4.2'}
        - {network: '10.11.25.0/24', next_hop: '172.16.4.2'}
      default_gateway: '192.168.178.1'
      remote_access: 'true'
      username: 'admin'
      password: 'VMware1!VMware1!'
      ha_enabled: 'true'
    register: create_dlr

  - name: Configure OSPF DLR
    nsx_ospf:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      edge_name: 'ansibleDLR'
      router_id: '172.24.1.3'
      default_originate: True
      graceful_restart: False
      logging: True
      log_level: debug
      forwarding_address: '172.24.1.2'
      protocol_address: '172.24.1.3'
      areas:
        - { area_id: 10 }
      area_map:
        - { area_id: 10, vnic: "{{ dlr_uplink_index }}" }      
    register: ospf_dlr

  - name: Configure OSPF ESG
    nsx_redistribution:
      ospf_state: present
      bgp_state: present
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      edge_name: 'ansibleESG'
      prefixes:
        - {name: 'testprfx1', network: '192.168.179.0/24'}
        - {name: 'testprfx2', network: '10.11.12.0/24'}
      rules:
        - {learner: 'ospf', priority: 0, static: false, connected: true, bgp: false, ospf: false, action: 'permit'}
        - {learner: 'ospf', priority: 1, static: 'true', connected: 'true', bgp: 'false', ospf: 'false', prefix: 'testprfx1', action: 'deny'}
        - {learner: 'bgp', priority: 1, connected: true, prefix: 'testprfx2', action: 'deny'}
        - {learner: 'bgp', priority: 0, connected: true, prefix: 'testprfx1'}
    register: redist
        
```

### Run the Playbook

- If the play completes successfully, you should see output similar to the following:
```
```

### Validate Results

## Edge Routing

Now that you have created the logical switches for the lab environment, and a logical router to provide first-hop and east-west routing services, you will next create an edge services gateway and configure it to provide north-south routing services to serve as a gateway for traffic flows that go between the virtual and physical routing environments. 

### Create The Playbook

In this section you will create and fully configure an NSX Edge Services Gateway (ESG). This ESG will serve as a gateway between the virtual and physical routing environments.  This lab will provision dynamic routing (OSPF) between the ESG and DLR. The ESG will also be configured with a default gateway of the internet router, and dynamic routing will not be configured between the ESG and the internet router. 

- The installation and configuration of the WSG requires several tasks that interact with multiple NSX Ansible modules. 
    - Task 1: Gather vCenter Moids
      - Description: 
        - Before you can deploy a ESG with the `nsx_edge_router` ansible module, you first need to gather the MOIDs for the resource pool (Cluster), datacenter, and datastor you would like the ESG to be provisioned to. In this playbook, you will build a single task that gathers all of these MOID values. Note that this is more streamlined than the method used in [Lab 3]() where you used a seperate task to gather each MOID independently. 
    - Task 2: ESG Creation
      - Description:
        - This task provides the needed values to create the ESG and provide the base IP configuration including interface configuration
    - Task 3: Configure OSPF ESG
      - Description:
        - Configure OSPF Settings on the DLR
 
- Create the playbook
  - Return to your terminal session with the Ansible server
  - `cd ~/nsxansible`
  - `vi createESG.yml`
  - Edit the file to look like the following:
```
---
- hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
     - answerfile.yml
  tasks:
  - name: Gather vCenter MOIDs
    vcenter_gather_moids:
      hostname: 'testvc.emea.nicira'
      username: 'administrator@vsphere.local'
      password: 'vmware'
      datacenter_name: 'nsxlabdc'
      cluster_name: 'compute'
      #resourcepool_name: 'test_rp'
      #dvs_name: 'TransportVDS'
      #portgroup_name: 'VM Network'
      #datastore_name: 'NFS-Storage03'
    register: gather_moids_output

  - name: DLR creation
    nsx_dlr:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      name: 'ansibleDLR'
      description: 'This DLR is created by nsxansible'
      resourcepool_moid: "{{ gather_moids_cl.object_id }}"
      datastore_moid: "{{ gather_moids_ds.object_id }}"
      datacenter_moid: "{{ gather_moids_cl.datacenter_moid }}"
      mgmt_portgroup_moid: "{{ gather_moids_pg.object_id }}"
      interfaces:
        - {name: 'Uplink vnic', ip: '192.168.178.2', prefix_len: 24, logical_switch: 'edge_ls', iftype: 'uplink'}
        - {name: 'Internal iface', ip: '172.16.1.1', prefix_len: 24, portgroup_id: "{{ gather_moids_pg.object_id }}", iftype: 'uplink'}
        - {name: 'Internal new', ip: '172.16.4.1', prefix_len: 26, logical_switch: 'new_lswitch_name', iftype: 'internal'}
      routes:
        - {network: '10.11.22.0/24', next_hop: '172.16.1.2', admin_distance: '1', mtu: '1500', description: 'very important route'}
        - {network: '10.11.23.0/24', next_hop: '172.16.1.2', mtu: '1600'}
        - {network: '10.11.24.0/24', next_hop: '172.16.4.2'}
        - {network: '10.11.25.0/24', next_hop: '172.16.4.2'}
      default_gateway: '192.168.178.1'
      remote_access: 'true'
      username: 'admin'
      password: 'VMware1!VMware1!'
      ha_enabled: 'true'
    register: create_dlr

  - name: Configure OSPF DLR
    nsx_ospf:
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      state: present
      edge_name: 'ansibleDLR'
      router_id: '172.24.1.3'
      default_originate: True
      graceful_restart: False
      logging: True
      log_level: debug
      forwarding_address: '172.24.1.2'
      protocol_address: '172.24.1.3'
      areas:
        - { area_id: 10 }
      area_map:
        - { area_id: 10, vnic: "{{ dlr_uplink_index }}" }      
    register: ospf_dlr

  - name: Configure OSPF ESG
    nsx_redistribution:
      ospf_state: present
      bgp_state: present
      nsxmanager_spec: "{{ nsxmanager_spec }}"
      edge_name: 'ansibleESG'
      prefixes:
        - {name: 'testprfx1', network: '192.168.179.0/24'}
        - {name: 'testprfx2', network: '10.11.12.0/24'}
      rules:
        - {learner: 'ospf', priority: 0, static: false, connected: true, bgp: false, ospf: false, action: 'permit'}
        - {learner: 'ospf', priority: 1, static: 'true', connected: 'true', bgp: 'false', ospf: 'false', prefix: 'testprfx1', action: 'deny'}
        - {learner: 'bgp', priority: 1, connected: true, prefix: 'testprfx2', action: 'deny'}
        - {learner: 'bgp', priority: 0, connected: true, prefix: 'testprfx1'}
    register: redist
        
```

### Run the Playbook

- If the play completes successfully, you should see output similar to the following:
```
```

### Validate Results